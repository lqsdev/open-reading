<?php
// Root id
$rootId = $comment['root'];
// Count
$count = $comment['count'];
// Target data:
// Title, time, user
// uid, name, avatar, profile_url
$target = $comment['target'];
// Comment list generated by comment module:
// id, time, content, user
// uid, name, avatar, profile_url, IP
$posts = $comment['posts'];
// Pagination object
$paginator = $comment['paginator'];
?>

<?php
if (!$target) {
    echo '<div class="alert">' . __('Item not found.') . '</div>';
    return;
} elseif (!$comment['active']) {
    echo '<div class="alert">' . __('Comment is disabled.') . '</div>';
}
$formData = array(
    'root'      => $comment['root'],
    'redirect'  => $this->url()->requestUri(true),
);
$form = Pi::service('comment')->getForm($formData);

$this->jQuery();
$this->backbone();
$this->css(array(
        $this->assetModule('css/front.css', 'comment'),
        Pi::url('static/vendor/bootstrap/css/font-awesome.css'),
    )
);

$uid = Pi::user()->id;
$avatar = Pi::avatar()->get($uid, 'medium', false);
if ($uid) {
    $url = Pi::service('user')->getUrl('profile', $uid);
} else {
    $url = Pi::url('www');
}
?>
<div class="pi-comment-article-title">
    <a class="highlight" href="<?php echo $target['url'] ?>" target="_blank" title="<?php echo _escape($target['title']); ?>">
        <?php echo _escape($target['title']); ?>
    </a>
</div>
<div class="pi-comment">
    <div class="pi-comment-header">
        <span><?php _e('All comments ') ?></span>
        <span>(<?php echo $count ?: 0 ?>)
        </span>
    </div>
    <?php 
        if ($comment['active']) {
    ?>
    <div class="pi-comment-form">
        <div class="media">
            <a class="pull-left" href="<?php echo $url ?>">
                <img class="media-object" src="<?php echo $this->escape($avatar) ?>">
            </a>
            <div class="media-body">
            <?php 
                if (empty($uid)) {
                    $redirect = Pi::engine()->application()->getRequest()->getUri()->getPath();
                    $loginUrl = Pi::user()->getUrl('login', $redirect);
            ?>
                <div class="form-unsign">
                    <span><a href="<?php echo $loginUrl ?>" class="highlight"><?php _e('Sign in') ?></a></span>
                    <span><?php _e(' to leave comments.') ?></span>
                </div>
            <?php
                } else {
                    echo $this->form()->openTag($form);
            ?>
                <div class="form-textarea">
                    <textarea placeholder="<?php _e('Type your content') ?>" name="content"></textarea>
                </div>
                <input class="btn form-submit pull-right hide" type="submit" value="<?php _e('Post') ?>" name="submit">
            <?php 
                    foreach (array(
                        'id', 'root', 'reply', 'module', 'category',
                        'item', 'redirect', 'markup') as $hiddenElement) {
                        echo $this->formElement($form->get($hiddenElement));
                    }
                    echo $this->form()->closeTag();
                }
            ?>
            </div>
        </div>
    </div>
    <?php
        }
        if (count($posts)) {
    ?>
    <div class="pi-comment-list">
    <?php 
        foreach ($posts as $post) {
    ?>
        <div class="media">
            <a class="pull-left" href="<?php echo $post['user']['url'] ?>" target="_blank">
                <?php echo $post['user']['avatar'] ?>
            </a>
            <div class="media-body">
                <div>
                    <span class="pi-comment-user">
                        <a href="<?php echo $post['user']['url'] ?>" target="_blank" title="<?php echo $post['user']['name']; ?>" class="highlight">
                            <?php echo $post['user']['name'] ?>
                        </a>
                    </span>
                    <span class="muted"><?php echo date('Y/m/d H:i:s', $post['time']) ?></span>
                </div>
                <div class="pi-comment-content"><?php echo $post['content'] ?></div>
                <div class="pi-comment-operation">
                <?php 
                    foreach ($post['operations'] as $operation => $optData) {
                        $class = '';
                        switch ($operation) {
                            case 'disable':
                                $class = 'icon-ban-circle';
                                break;
                            case 'edit':
                                $class = 'icon-pencil';
                                break;
                            case 'delete':
                                $class = 'icon-trash';
                                break;
                            case 'reply':
                                $class = 'icon-share-alt';
                                break;
                        }
                ?>
                    <span class="operation muted">
                        <a href="<?php echo $optData['url'] ?>">
                            <i class="<?php echo $class ?>" style="text-decoration: none"></i><?php echo $optData['title'] ?>
                        </a>
                    </span>
                <?php
                    }
                ?>
                </div>
            </div>
        </div>
    <?php 
        }
    ?>
    </div>
    <?php 
        } else {
    ?>
    <div class="pi-comment-none"><?php _e('No one has commented yet.') ?></div>
    <?php
        }
    ?>
</div>

<div>
    <?php if (count($posts)) {
        if ($paginator) {
            echo $this->pagination(
            $paginator,
            'Sliding',
            'paginator.phtml',
            array('class' => 'pagination-right'));
        }
    }
    ?>
</div>

<script>
(function($) {
var page = {
    range   : $(".pi-comment"),
    $       : function(selector) {
       return this.range.find(selector);
    }
};

var CommentView = Backbone.View.extend({
    events          : {
        "click textarea"   :"expandTextarea",
        "mouseover .pi-comment-list .media" : "displayOperation",
        "mouseout .pi-comment-list .media"  : "hideOperation"
    },
    initialize      : function() {
        this.$el   = $(".pi-comment");
    },
    expandTextarea  : function() {
        var text  = this.$("textarea");
        var textForm = this.$(".form-textarea");
        
        text.css({
            "height"     : "75px",
            "min-height" : "75px",
            "max-height" : "auto"
        });
        textForm.css({
            "height"     : "75px"
        });
        this.$(".form-submit").removeClass("hide");
    },
    displayOperation    : function(e) {
        var el = $(e.target).parents(".media");
        el.find(".pi-comment-operation").css("visibility", "visible");
    },
    hideOperation   : function(e) {
        var el = $(e.target).parents(".media");
        el.find(".pi-comment-operation").css("visibility", "hidden");
    }
});
new CommentView;
})(jQuery)
</script>
